<html xmlns="http://www.w3.org/1999/xhtml" xmlns:n="http://nevow.com/ns/nevow/0.1">
  <head>
    <!-- per http://www.piclens.com/lite/webmasterguide.php -->
    <link rel="alternate" href="?rss=1" 
	  type="application/rss+xml" title="" id="gallery" />
    <script type="text/javascript" 
          src="http://lite.piclens.com/current/piclens.js" ></script>

    <!-- if we're on a phone screen, things should shrink accordingly -->
   <link rel="Stylesheet" type="text/css" href="/static/styles.css" media="all" />
    <title><n:invisible n:render="title"/></title>
  </head>
  <body>
    <div><n:invisible n:render="loginWidget"/></div>
	    <div id="ajaxError" style="display:none"/>
    <h1>Pictures of <span class="tag"><n:invisible n:render="setLabel"/></span></h1>

    <div class="intro" n:render="intro"></div>

    <div class="featured">
      <h2><n:invisible n:render="currentLabel">Mark and Stephanie play Magic [1 of 16]</n:invisible></h2>
      
      <div style="width:1000px">
	<div style="float: left; width: 600px">
	  <div><img width="500" height="300" alt="Mark and Stephanie" n:render="featured"/></div>
	  <n:invisible n:render="stepButtons"/>
	</div>
	<div style="float: left; width: 400px">
	  <div class="actions" n:render="actionsAllowed">
	    <h2>Actions</h2>
	    <div class="ac"><n:invisible n:render="public"/></div>
	    <div class="ac"><n:invisible n:render="uploadButton"/></div>
	    <div class="ac" style="opacity: .4">Email</div>
	    <div class="ac" style="opacity: .4">Post to blog</div>
	    <div class="ac"><a><n:attr name="href">http://bang:8080/openrdf-workbench/repositories/photo/explore?resource=&lt;<n:invisible n:render="currentPhotoUri"/>&gt;</n:attr>Debug rdf</a></div>

	  </div>
	  <div class="actions">
	    <h2>Links</h2>
	    <div class="ac">
	      More images:
	      <ul n:render="sequence" n:data="related">
		<li n:pattern="item">
		  <n:invisible n:render="string" n:data="0"/> 
		  <a><n:attr name="href"><n:invisible n:render="string" n:data="1"/></n:attr><n:invisible n:render="string" n:data="2"/></a>
		</li>
	      </ul>
	    </div>
	    <div class="ac">Sizes: <n:invisible n:render="otherSizeLinks"/></div>
	    <div class="ac">
	      <div>Link to this image: </div>
	      <div style="font-size: 60%"><n:invisible n:render="link"/></div>
	    </div>

	  </div>
	</div>
	<div style="clear: both"/>
      </div>
    </div>

    <table id="t1">
      <tr>
	<td>
	  <div class="imageInfo">
	    <n:invisible n:render="facts"/>
	  </div>
	</td>

	<td>
	  <div class="tagging">
	    <div>Tags: <input type="text" id="tags"/> </div>
	    <div>Description: <textarea id="desc"></textarea></div>
	    <div n:render="allowedToWriteMeta"><button id="saveMeta">save</button> <span id="saveStatus"/></div>
	  </div>
	</td>
	<td>
	  <div id="comments" style="height:165px"></div>
	</td>
      </tr>
    </table>
    <div>
      <h2>All photos in set:</h2>
      <n:invisible n:render="prevNextDateButtons"/>

      <div>
	<a href="javascript:PicLensLite.start();">View as slideshow 
	<img src="http://lite.piclens.com/images/PicLensButton.png" 
	     alt="PicLens" width="16" height="12" border="0" 
	     align="absmiddle" /></a>
      </div>
      <div class="photosInSet">
	<n:invisible n:render="sequence" n:data="photosInSet">
	  <n:invisible n:pattern="item">
	    <n:invisible n:render="thumb"/>
	  </n:invisible>
	  <img width="70" height="50"/>
	  <img width="70" height="50"/>
	</n:invisible>
      </div>
    </div>

    <div class="ac">
      <div class="expand">&#8853; tag range</div>
      <div class="tagRange">
	<div id="rangeState"></div>
	<div id="rangeStart">
	  1. <button>Pick range start</button>: 
	  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAADElEQVR42mP4//8/AAX+Av4zEpUUAAAAAElFTkSuQmCC"/>
	  <span class="pick"/>
	</div>
	<div id="rangeEnd">
	  2. <button>Pick range end</button>: 
	  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAADElEQVR42mP4//8/AAX+Av4zEpUUAAAAAElFTkSuQmCC"/>
	  <span class="pick"/>
	</div>
	<div id="addForm">
	  <div>
	    3. These pictures depict: <input name="label" id="addColumnLabel" type="text"/>
	  </div>
	  <div class="uriControl">
	    <div style="float:left; padding-left: 10px;">
	      Class:
	      <select name="class" style="vertical-align: top" size="3"> <!-- should be radios-->
		<option value="http://xmlns.com/foaf/0.1/Person">Person</option>
		<option value="http://photo.bigasterisk.com/0.1/Place">Place</option>
		<option value="http://photo.bigasterisk.com/0.1/Event" selected="selected">Event</option>
	      </select>
	    </div>
	    <div style="float:left; padding-left: 10px;">
	      URI: <input id="add-uri" name="uri" type="text" size="50"/>
	    </div>
	    <div style="clear:both"></div>
	  </div>
	  <div>4. <button id="submitRange">Add tag</button></div>
	</div>
      </div>
    </div>

    <div>
      Download a <a rel="nofollow"><n:attr name="href"><n:invisible n:render="zipUrl"/></n:attr>.zip file of the full size images on this page</a> <n:invisible n:render="zipSizeWarning"/>
    </div>


    <!--    <div>
	 <h2>Related</h2>
	 
	 </div>-->

    <script type="text/javascript" src="/static/jquery-1.3.2.min.js"></script>
    <script type="text/javascript" src="/static/jquery.form.js"></script>
    <script type="text/javascript" n:render="prevNextJs"/>
    
    <script type="text/javascript">
      var currentPhotoUri = "<n:invisible n:render="currentPhotoUri"/>";
      var preloadImg = "<n:invisible n:render="nextImagePreload"/>";
    </script>

    <script type="text/javascript">
      // <![CDATA[

      $(function () {
	  function slug(s) {
	      s = s.replace(/^\s*/, "").replace(/\s*$/, "");
	      s = s.replace(/[^a-zA-Z0-9\-_\s]/g, "");
	      s = s.toLowerCase();
	      s = s.replace(/[-_\s]+([a-z0-9])/ig, 
				    function(z,b) { return b.toUpperCase();} );
	      return s;
	  }

	  $(".expand").click(function () { 
	      $(this).next().toggle('fast');
	      return false;
	  }).next().hide();

	  function startImagePick(msg, cb) {
	      $("#rangeState").text("Click an image to pick " + msg);
	      $("body,img").css("cursor", "crosshair");
	      $("img").bind("click", function () {
		  stopImagePick();
		  cb(this);
		  return false;
	      });
	  }
	  function stopImagePick() {
	      $("img").unbind("click");
	      $("body,img").css("cursor", "");
	      $("#rangeState").text("");
	  }

	  function uriFromImg(el) {
	      return 'http://photo.bigasterisk.com' + $(el).attr('src').replace(/\?.*/, "");
	  }

	  $("#rangeStart button").click(function() {
	      startImagePick("range start", function(picked) {
		  $("#rangeStart .pick").text(uriFromImg(picked));
		  $("#rangeStart img").attr("src", $(picked).attr("src"));
	      });
	  });

	  $("#rangeEnd button").click(function() {
	      startImagePick("range end", function(picked) {
		  $("#rangeEnd .pick").text(uriFromImg(picked));
		  $("#rangeEnd img").attr("src", $(picked).attr("src"));
	      });
	  });

	  function updateTagUrl() {
	      var cls = $('#addForm select[name=class]').val();
	      var clsWord = /\/([^\/]+)$/.exec(cls)[1].toLowerCase();
	      var label = $('#addForm input[name=label]').val();
	      
	      var newUri = ("http://photo.bigasterisk.com/" + 
			    (new Date()).getFullYear() + "/" + 
			    clsWord + "/" + 
			    encodeURIComponent(slug(label)));
	      $('#add-uri').val(newUri);
	  }
	  $("#addForm select[name=class], #addForm input[name=label]"
	   ).bind("keyup change", updateTagUrl);
	  
	  $("#submitRange").click(function () {
	      $("#rangeState").text("saving...");
	      $.post(document.location + "&tagRange=1", 
		     {start: $("#rangeStart .pick").text(), 
		      end: $("#rangeEnd .pick").text(), 
		      rdfClass: $('#addForm select[name=class]').val(),
		      label: $("#addForm input[name=label]").val(), 
		      uri: $("#addForm input[name=uri]").val()},
		     function (data, textStatus) {
			 $("#rangeState").html(data.msg);
		     }, "json");
	  });



	  function startNextImgPreload() {
	      $("#preload").attr('src', preloadImg);
	  }

	  $(window).keydown(function (e) {
	      if (e.which == 37) { 
		  document.location = arrowPages.prev;
	      } else if (e.which == 39) {
		  document.location = arrowPages.next;
	      }

	  });

	  $.get("/comments", 
		{post: currentPhotoUri}, 
		function (result) { 
		    $("#comments").html(result); 
		    $("#comments").removeAttr("style");
		}, "html");

	  $("#saveMeta").click(function () {
	      $("#saveStatus").text("");
	      $.post("/tagging", {
		  img: currentPhotoUri,
		  tags: $("#tags").val(),
		  desc: $("#desc").val()}, 
		     function(data) { 
			 $("#saveStatus").text("ok");
			 refreshTags(data);
		     },
		     "json");
	  });

	  function refreshTags(data) {
	      $("#tags").val(data.tagString);
	      $("#desc").val(data.desc);

	      $("#otherWithTag").empty();
	      $.each(data.tags, function (i, tag) {
		  $("#otherWithTag").append("<div><a href=\"/set?tag="+tag+"\">"+tag+"</a></div>");
	      });
		    startNextImgPreload(); // try to do this after other work

	  }

	  $.getJSON("/tagging", 
		    {img: currentPhotoUri},
		    refreshTags);

	  $("#ajaxError").ajaxError(function (event, xhr, ajaxOptions) {
	      $(this).show();
	      $(this).append("<p>Ajax error: "+xhr.responseText+"</p>");
	  });

          $(".makePub").click(function() {
	      var button = $(this);
	      $.post('/makePublic', {uri: currentPhotoUri},
		  function(data, textStatus) {
		    button.replaceWith(data);
	      });
	  });
		  
      });

      function flickrUpload() {
	  var st = $("#flickrUpload");

          var sz = $("#flickrUpload input[name=size]:checked").val();
	  st.html('Uploading... ' +
		  '<img class="spinner" src="static/snake-spinner.gif"/>');
		  
	  $.post("http://photo.bigasterisk.com/flickrUpload/",
		 {img: currentPhotoUri,
		  size: sz,
		  test: ''}, 
		 function (data) {
		     st.html("Done: " +
			     "<a href=\""+data.flickrUrl+"\">flickr copy</a>");
		 }, "json");
      }

      

      // ]]>
    </script>

    <img id="preload" src=""/>
  </body>
</html>
